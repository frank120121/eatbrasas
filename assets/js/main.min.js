import{CONFIG}from"./modules/config.js";import{getElement,getElements}from"./modules/utils.js";import{ToastManager,toast}from"./modules/ui/toast.js";import{HeaderManager,headerManager}from"./modules/ui/header.js";import{NavigationManager,navigationManager}from"./modules/ui/navigation.js";import{AnimationManager,animationManager}from"./modules/ui/animations.js";import{BusinessStatus,businessStatus}from"./modules/business/status.js";import{ContactManager,contactManager}from"./modules/business/contact.js";import{ImageLoader,imageLoader}from"./modules/product/image-loading.js";class BrasasSmokehouseApp{constructor(){this.managers={},this.isInitialized=!1,this.initializationQueue=[],this.criticalInitComplete=!1,this.contentVisibilityEnsured=!1}async init(){try{console.log("üî• Starting Brasas Smokehouse PWA..."),this.ensureContentVisibility(),await this.initCritical(),requestAnimationFrame(()=>this.initImportant()),this.scheduleEnhancements()}catch(e){console.error("‚ùå App initialization error:",e),this.ensureContentVisibility(),this.initFallbackMode()}}ensureContentVisibility(){if(this.contentVisibilityEnsured)return;console.log("üîß Ensuring content visibility..."),document.documentElement.classList.remove("no-js");const e=getElements("#menu, #location, #contacto, section");e.forEach(e=>{e.style.display="",e.style.visibility="visible",e.style.opacity="1",e.classList.remove("hidden","invisible")});const t=getElements(".product-card, .category-preview-card");t.forEach(e=>{e.style.display="",e.style.visibility="visible",e.style.opacity="1",e.classList.remove("hidden","invisible")});const n=getElements("img");n.forEach(e=>{null!==e.offsetParent?(e.style.visibility="visible",e.style.opacity="1",e.style.display="",e.dataset.src&&!e.src&&(e.src=e.dataset.src)):e.dataset.src&&!e.src&&(e.src=e.dataset.src)});getElements("#categories-grid, .grid").forEach(e=>{e.style.display="grid",e.style.visibility="visible",e.style.opacity="1"}),this.contentVisibilityEnsured=!0,console.log(`‚úÖ Content visibility ensured for ${e.length} sections, ${t.length} cards, ${n.length} images`)}async initCritical(){this.managers.toast=toast,this.managers.header=headerManager,this.managers.header.showToast=this.showToast.bind(this),this.managers.header.init(),this.criticalInitComplete=!0,console.log("‚úÖ Critical features initialized")}initImportant(){if(this.criticalInitComplete)try{this.managers.navigation=navigationManager,this.managers.navigation.showToast=this.showToast.bind(this),this.managers.navigation.init(),this.managers.businessStatus=businessStatus,this.managers.businessStatus.showToast=this.showToast.bind(this),this.managers.businessStatus.init(),this.managers.contactManager=contactManager,this.managers.contactManager.showToast=this.showToast.bind(this),this.managers.contactManager.init(),console.log("‚úÖ Important features initialized")}catch(e){console.error("‚ùå Important features error:",e)}}scheduleEnhancements(){const e=()=>{try{this.managers.animationManager=animationManager,this.managers.animationManager.showToast=this.showToast.bind(this),this.managers.animationManager.init(),this.managers.imageLoader=imageLoader,this.managers.imageLoader.showToast=this.showToast.bind(this),this.managers.imageLoader.init(),this.isInitialized=!0,console.log("‚úÖ All features initialized"),this.performFinalCheck()}catch(e){console.error("‚ùå Enhancement features error:",e),this.performFinalCheck()}};"requestIdleCallback"in window?requestIdleCallback(e,{timeout:3e3}):setTimeout(e,1e3)}performFinalCheck(){setTimeout(()=>{const e=this.findHiddenElements();e.length>0?(console.warn(`‚ö†Ô∏è Found ${e.length} hidden elements - making visible`),this.ensureContentVisibility(),this.managers.animationManager?.forceShowAll&&this.managers.animationManager.forceShowAll(),this.managers.imageLoader?.forceLoadAll&&this.managers.imageLoader.forceLoadAll()):console.log("‚úÖ All content confirmed visible")},2e3)}findHiddenElements(){const e=[];return["#menu","#location","#contacto",".product-card",".category-preview-card","#categories-grid"].forEach(t=>{getElements(t).forEach(t=>{const n=window.getComputedStyle(t);"none"!==n.display&&"hidden"!==n.visibility&&"0"!==n.opacity||e.push(t)})}),e}initFallbackMode(){console.warn("üö® Initializing fallback mode"),this.ensureContentVisibility(),setTimeout(()=>{this.showToast("Algunas funciones avanzadas est√°n limitadas","info",4e3)},2e3)}showToast(e,t="success",n=3e3){return this.managers.toast?this.managers.toast.show(e,t,n):(console.log(`Toast: ${e} (${t})`),null)}emergencyVisibilityFix(){console.log("üö® Running emergency visibility fix..."),this.ensureContentVisibility(),Object.values(this.managers).forEach(e=>{e?.forceShowAll&&e.forceShowAll(),e?.forceLoadAll&&e.forceLoadAll()}),console.log("‚úÖ Emergency fix completed")}getStats(){const e={initialized:this.isInitialized,critical:this.criticalInitComplete,contentVisible:this.contentVisibilityEnsured,managers:Object.keys(this.managers),hiddenElements:this.findHiddenElements().length};return Object.entries(this.managers).forEach(([t,n])=>{n?.getStats&&(e[`${t}Stats`]=n.getStats())}),e}destroy(){Object.values(this.managers).forEach(e=>{e&&"function"==typeof e.destroy&&e.destroy()}),this.managers={},this.isInitialized=!1,this.contentVisibilityEnsured=!1}}class ServiceWorkerIntegration{constructor(e){this.app=e,this.isIntegrated=!1,this.retryCount=0,this.maxRetries=10,this.init()}init(){this.waitForReadiness()}waitForReadiness(){const e=()=>{const t=this.app&&this.app.criticalInitComplete&&this.app.managers.toast,n=window.swManager;t&&n?this.integrateServiceWorker():this.retryCount<this.maxRetries?(this.retryCount++,setTimeout(e,200)):console.warn("‚ö†Ô∏è SW Integration timeout - app or SW not ready")};e()}integrateServiceWorker(){if(!this.isIntegrated)try{window.swManager.showToast=(e,t,n)=>this.app.showToast(e,t,n),window.swManager.showInstallPrompt=()=>{this.showProperInstallPrompt()},window.swManager.showUpdateNotification=()=>{this.showProperUpdateNotification()},this.isIntegrated=!0,console.log("‚úÖ Service Worker integrated with main app toast system")}catch(e){console.error("‚ùå SW Integration failed:",e)}}showProperInstallPrompt(){const e=localStorage.getItem("pwa-install-dismissed");e&&Date.now()<parseInt(e)||this.createInstallToast()}showProperUpdateNotification(){this.createUpdateToast()}createInstallToast(){const e=document.getElementById("toast-container")||this.createToastContainer(),t=document.createElement("div");t.className="toast info show",t.setAttribute("role","alert"),t.setAttribute("aria-live","assertive"),t.style.cssText="\n            background: linear-gradient(135deg, #007bff, #0056b3);\n            color: white;\n            padding: 24px;\n            border-radius: 16px;\n            margin-bottom: 12px;\n            box-shadow: 0 12px 40px rgba(0,123,255,0.3);\n            border: 1px solid rgba(255,255,255,0.2);\n            backdrop-filter: blur(12px);\n            max-width: 420px;\n            position: relative;\n            pointer-events: auto;\n            font-family: inherit;\n        ";const n=document.createElement("div");n.style.cssText="display: flex; align-items: center; margin-bottom: 16px;";const i=document.createElement("span");i.textContent="üá≤üáΩ",i.style.cssText="font-size: 28px; margin-right: 12px;";const s=document.createElement("div"),a=document.createElement("strong");a.textContent="Instalar Brasas Smokehouse",a.style.cssText="font-size: 18px; display: block;";const o=document.createElement("span");o.textContent="Aplicaci√≥n Web Progresiva",o.style.cssText="font-size: 14px; opacity: 0.9;",s.appendChild(a),s.appendChild(o),n.appendChild(i),n.appendChild(s);const r=document.createElement("div");r.style.cssText="margin-bottom: 20px; line-height: 1.5;";const l=document.createElement("div");l.style.cssText="display: flex; align-items: center; margin-bottom: 8px;";const c=document.createElement("span");c.textContent="‚úÖ",c.style.marginRight="8px";const d=document.createElement("span");d.textContent="Funciona completamente sin internet",d.style.fontSize="14px",l.appendChild(c),l.appendChild(d);const p=document.createElement("div");p.style.cssText="display: flex; align-items: center; margin-bottom: 8px;";const m=document.createElement("span");m.textContent="‚úÖ",m.style.marginRight="8px";const g=document.createElement("span");g.textContent="Ahorra datos m√≥viles en Sonora",g.style.fontSize="14px",p.appendChild(m),p.appendChild(g);const h=document.createElement("div");h.style.cssText="display: flex; align-items: center;";const u=document.createElement("span");u.textContent="‚úÖ",u.style.marginRight="8px";const y=document.createElement("span");y.textContent="Acceso r√°pido desde tu pantalla",y.style.fontSize="14px",h.appendChild(u),h.appendChild(y),r.appendChild(l),r.appendChild(p),r.appendChild(h);const b=document.createElement("div");b.style.cssText="display: flex; gap: 12px; flex-wrap: wrap;";const x=document.createElement("button");x.textContent="üì± Instalar Ahora",x.style.cssText="\n            background: white; \n            color: #ad2118; \n            border: none; \n            padding: 14px 24px; \n            border-radius: 10px; \n            cursor: pointer; \n            font-weight: bold; \n            font-size: 15px;\n            transition: transform 0.2s;\n            flex: 1;\n            min-width: 140px;\n        ",x.onmouseover=()=>x.style.transform="scale(1.02)",x.onmouseout=()=>x.style.transform="scale(1)",x.onclick=()=>{window.swManager.installPWA(),t.remove()};const f=document.createElement("button");f.textContent="M√°s Tarde",f.style.cssText="\n            background: rgba(255,255,255,0.1); \n            color: white; \n            border: 1px solid rgba(255,255,255,0.3); \n            padding: 14px 24px; \n            border-radius: 10px; \n            cursor: pointer; \n            font-size: 15px;\n            transition: background-color 0.2s;\n            flex: 1;\n            min-width: 120px;\n        ",f.onmouseover=()=>f.style.backgroundColor="rgba(255,255,255,0.2)",f.onmouseout=()=>f.style.backgroundColor="rgba(255,255,255,0.1)",f.onclick=()=>{window.swManager.dismissInstall(),t.remove()},b.appendChild(x),b.appendChild(f);const w=document.createElement("button");return w.innerHTML="√ó",w.style.cssText="\n            position: absolute;\n            top: 12px;\n            right: 16px;\n            background: none;\n            border: none;\n            color: white;\n            font-size: 24px;\n            cursor: pointer;\n            padding: 0;\n            width: 28px;\n            height: 28px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            opacity: 0.7;\n            transition: opacity 0.2s;\n            border-radius: 50%;\n        ",w.onmouseover=()=>w.style.opacity="1",w.onmouseout=()=>w.style.opacity="0.7",w.onclick=()=>t.remove(),t.appendChild(w),t.appendChild(n),t.appendChild(r),t.appendChild(b),e.appendChild(t),setTimeout(()=>{t.parentNode&&t.remove()},3e4),t}createUpdateToast(){const e=document.getElementById("toast-container")||this.createToastContainer(),t=document.createElement("div");t.className="toast info show",t.setAttribute("role","alert"),t.setAttribute("aria-live","assertive"),t.style.cssText="\n            background: linear-gradient(135deg, #28a745, #20c997);\n            color: white;\n            padding: 20px;\n            border-radius: 12px;\n            margin-bottom: 12px;\n            box-shadow: 0 8px 32px rgba(40,167,69,0.3);\n            border: 1px solid rgba(255,255,255,0.2);\n            backdrop-filter: blur(10px);\n            max-width: 400px;\n            position: relative;\n            pointer-events: auto;\n            font-family: inherit;\n        ";const n=document.createElement("div");n.style.cssText="display: flex; align-items: center; margin-bottom: 16px;";const i=document.createElement("span");i.textContent="üîÑ",i.style.cssText="font-size: 24px; margin-right: 12px;";const s=document.createElement("div"),a=document.createElement("strong");a.textContent="Nueva versi√≥n disponible",a.style.cssText="font-size: 16px;";const o=document.createElement("div");o.textContent="Mejoras para M√©xico y nuevas funciones",o.style.cssText="font-size: 13px; opacity: 0.9;",s.appendChild(a),s.appendChild(o),n.appendChild(i),n.appendChild(s);const r=document.createElement("div");r.style.cssText="display: flex; gap: 12px;";const l=document.createElement("button");l.textContent="Actualizar Ahora",l.style.cssText="\n            background: white; \n            color: #28a745; \n            border: none; \n            padding: 12px 20px; \n            border-radius: 8px; \n            cursor: pointer; \n            font-weight: bold; \n            font-size: 14px;\n            transition: transform 0.2s;\n            flex: 1;\n        ",l.onmouseover=()=>l.style.transform="scale(1.02)",l.onmouseout=()=>l.style.transform="scale(1)",l.onclick=()=>{window.swManager.applyUpdate(),t.remove()};const c=document.createElement("button");return c.textContent="M√°s Tarde",c.style.cssText="\n            background: rgba(255,255,255,0.1); \n            color: white; \n            border: 1px solid rgba(255,255,255,0.3); \n            padding: 12px 20px; \n            border-radius: 8px; \n            cursor: pointer; \n            font-size: 14px;\n            transition: background-color 0.2s;\n        ",c.onmouseover=()=>c.style.backgroundColor="rgba(255,255,255,0.2)",c.onmouseout=()=>c.style.backgroundColor="rgba(255,255,255,0.1)",c.onclick=()=>t.remove(),r.appendChild(l),r.appendChild(c),t.appendChild(n),t.appendChild(r),e.appendChild(t),setTimeout(()=>{t.parentNode&&t.remove()},1e4),t}createToastContainer(){const e=document.createElement("div");return e.id="toast-container",e.className="fixed top-4 right-4 z-50 space-y-2",e.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            left: 20px;\n            z-index: 10000;\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n            pointer-events: none;\n            max-width: 440px;\n            margin: 0 auto;\n        ",e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Notificaciones"),document.body.appendChild(e),e}getIntegrationStatus(){return{isIntegrated:this.isIntegrated,retryCount:this.retryCount,appReady:!(!this.app||!this.app.criticalInitComplete),swReady:!!window.swManager}}}const app=new BrasasSmokehouseApp;window.app=app,document.addEventListener("DOMContentLoaded",()=>{const e=()=>{window.app&&app.criticalInitComplete?(new ServiceWorkerIntegration(app),console.log("‚úÖ Service Worker integration initialized")):setTimeout(e,200)};setTimeout(e,100)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>app.init()):app.init(),window.addEventListener("error",e=>{console.error("Global error:",e.error?.message||e.message),app.ensureContentVisibility()}),window.addEventListener("beforeunload",()=>{app.destroy()}),"undefined"!=typeof process&&"development"===process.env?.NODE_ENV&&window.addEventListener("load",()=>{setTimeout(()=>{const e=performance.getEntriesByType("navigation")[0];if(e){const t=e.loadEventEnd-e.loadEventStart;console.log(`‚ö° Page load: ${t.toFixed(0)}ms`)}},100)}),window.copyAddress=()=>app.managers.contactManager?.copyAddress?.(),window.checkBusinessStatus=()=>app.managers.businessStatus?.checkBusinessStatus?.(),window.updateBusinessStatus=()=>app.managers.businessStatus?.updateBusinessStatus?.(),window.emergencyVisibilityFix=()=>app.emergencyVisibilityFix(),window.forceShowAllContent=()=>app.ensureContentVisibility(),"undefined"!=typeof process&&"development"===process.env?.NODE_ENV?(window.BrasasDebug={app:app,managers:()=>app.managers,reinit:()=>app.init(),stats:()=>app.getStats(),forceShow:()=>app.emergencyVisibilityFix(),checkHidden:()=>app.findHiddenElements()},console.log("üîß Debug tools: window.BrasasDebug")):window.BrasasDebug={app:app,stats:()=>app.getStats(),forceShow:()=>app.emergencyVisibilityFix()};