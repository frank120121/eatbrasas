import{getElement,getElements,setAttributes}from"../utils.js";export class NavigationManager{constructor(t=null){this.showToast=t,this.navButtons=[],this.sections=[],this.activeSection=null,this.isScrolling=!1,this.scrollTimeout=null,this.observer=null,this.isLowEndDevice=!1}async init(){"requestIdleCallback"in window?requestIdleCallback(()=>this.performInit(),{timeout:1e3}):setTimeout(()=>this.performInit(),200)}performInit(){try{if(this.detectDevice(),this.findElements(),0===this.navButtons.length)return void console.log("No navigation elements found");this.setupNavigation(),this.isLowEndDevice?this.initStaticNavigation():this.initScrollspy(),console.log(`‚úÖ Navigation ready (${this.isLowEndDevice?"static":"dynamic"} mode)`)}catch(t){console.error("‚ùå Navigation init error:",t),this.initFallback()}}detectDevice(){const t={lowMemory:navigator.deviceMemory&&navigator.deviceMemory<4,lowCPU:navigator.hardwareConcurrency&&navigator.hardwareConcurrency<4,slowConnection:navigator.connection&&("2g"===navigator.connection.effectiveType||"slow-2g"===navigator.connection.effectiveType||navigator.connection.downlink<1.5),oldDevice:/Android [1-6]\./i.test(navigator.userAgent)};this.isLowEndDevice=Object.values(t).some(Boolean),this.isLowEndDevice&&console.log("üì± Low-end device detected for navigation")}findElements(){this.navButtons=[...getElements(".category-nav-btn")],this.sections=[...getElements(".menu-category")],this.sectionMap=new Map,this.sections.forEach(t=>{const e=t.dataset.category||t.id;e&&(this.sectionMap.set(e,t),t.dataset.category||(t.dataset.category=e))})}setupNavigation(){const t=this.navButtons[0]?.parentElement;t&&(t.addEventListener("click",this.handleNavClick.bind(this)),this.navButtons.forEach((t,e)=>{setAttributes(t,{role:"tab","aria-selected":"false",tabindex:0===e?"0":"-1"})}),this.navButtons.length>0&&this.setActiveButton(this.navButtons[0].dataset.category,!1))}handleNavClick(t){const e=t.target.closest(".category-nav-btn");if(!e||!e.dataset.category)return;t.preventDefault();const i=e.dataset.category;this.setActiveButton(i,!0),this.scrollToSection(i)}scrollToSection(t){const e=this.sectionMap.get(t);if(!e)return void console.warn("Section not found:",t);const i=e.getBoundingClientRect(),s=window.pageYOffset+i.top-120;this.isScrolling=!0,clearTimeout(this.scrollTimeout),window.scrollTo({top:s,behavior:"smooth"}),this.scrollTimeout=setTimeout(()=>{this.isScrolling=!1},800)}initScrollspy(){if(!("IntersectionObserver"in window))return void console.warn("IntersectionObserver not supported");let t;this.observer=new IntersectionObserver(e=>{this.isScrolling||(clearTimeout(t),t=setTimeout(()=>{let t=null,i=0;if(e.forEach(e=>{e.isIntersecting&&e.intersectionRatio>i&&(i=e.intersectionRatio,t=e.target)}),t){const e=t.dataset.category;e&&e!==this.activeSection&&this.setActiveButton(e,!1)}},100))},{threshold:.3,rootMargin:"-100px 0px -30% 0px"}),this.sections.forEach(t=>this.observer.observe(t))}initStaticNavigation(){console.log("üì± Static navigation mode (low-end device)")}setActiveButton(t,e=!1){if(!t||t===this.activeSection)return;const i=()=>{this.navButtons.forEach(e=>{e.dataset.category===t?e.classList.contains("active")||(e.classList.add("active"),e.setAttribute("aria-selected","true")):e.classList.contains("active")&&(e.classList.remove("active"),e.setAttribute("aria-selected","false"))})};e||this.isLowEndDevice?i():requestAnimationFrame(i),this.activeSection=t}initFallback(){console.warn("üö® Navigation fallback mode"),this.navButtons.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();const i=t.dataset.category;i&&this.scrollToSection(i)})})}navigateToCategory(t){return!!this.sectionMap.get(t)&&(this.setActiveButton(t,!0),this.scrollToSection(t),!0)}getNavigationState(){return{activeSection:this.activeSection,totalSections:this.sections.length,isLowEndDevice:this.isLowEndDevice,hasScrollspy:!!this.observer}}refresh(){if(console.log("Refreshing navigation..."),this.findElements(),this.observer&&!this.isLowEndDevice&&(this.observer.disconnect(),this.sections.forEach(t=>this.observer.observe(t))),this.sections.length>0){const t=this.sections[0],e=t.dataset.category||t.id;e&&this.setActiveButton(e,!1)}}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.scrollTimeout&&(clearTimeout(this.scrollTimeout),this.scrollTimeout=null),this.navButtons=[],this.sections=[],this.sectionMap=null,this.activeSection=null,console.log("Navigation destroyed")}}export const navigationManager=new NavigationManager;