import{getElement,getElements}from"../utils.js";export class AnimationManager{constructor(e=null){this.showToast=e,this.isInitialized=!1,this.reducedMotion=!1,this.isLowEndDevice=!1,this.visibilityObserver=null,this.elementsToReveal=new Set,this.fallbackTimeout=null}async init(){this.performInit()}performInit(){try{this.detectDeviceCapabilities(),this.checkMotionPreferences(),this.ensureContentVisibility(),this.isLowEndDevice||this.reducedMotion?this.initAccessibleMode():this.initProgressiveEnhancement(),this.initEssentials(),this.setupFallbacks(),this.isInitialized=!0,console.log(`✅ Animation manager initialized (${this.getMode()} mode)`)}catch(e){console.error("❌ Animation init error:",e),this.initAccessibleMode()}}ensureContentVisibility(){const e=getElements("section, .product-card, .category-preview-card, #menu, #location, #contacto");e.forEach(e=>{e.style.display="",e.style.visibility="visible",e.style.opacity="1",e.classList.remove("hidden","invisible")});getElements(".fade-in").forEach(e=>{e.classList.contains("animate-on-scroll")||(e.style.opacity="1",e.style.transform="translateY(0)",e.style.visibility="visible")}),console.log(`✅ Ensured visibility for ${e.length} elements`)}detectDeviceCapabilities(){const e={lowMemory:navigator.deviceMemory&&navigator.deviceMemory<3,lowCPU:navigator.hardwareConcurrency&&navigator.hardwareConcurrency<4,slowConnection:navigator.connection&&("2g"===navigator.connection.effectiveType||"slow-2g"===navigator.connection.effectiveType||navigator.connection.downlink<2),oldBrowser:!window.IntersectionObserver||!window.requestAnimationFrame};this.isLowEndDevice=Object.values(e).some(Boolean)}checkMotionPreferences(){try{this.reducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches}catch(e){this.reducedMotion=!1}}initAccessibleMode(){getElements(".fade-in, [data-animate]").forEach(e=>{e.style.opacity="1",e.style.transform="none",e.style.visibility="visible",e.classList.add("visible"),e.classList.remove("animate-on-scroll")}),this.handleVideos(),console.log("♿ Accessible mode - all content immediately visible")}initProgressiveEnhancement(){this.markElementsForAnimation(),this.initSafeScrollAnimations(),this.initBasicInteractions()}markElementsForAnimation(){const e=getElements(".fade-in");e.forEach((e,t)=>{const i=e.getBoundingClientRect().top<window.innerHeight,s=e.closest("#menu, #location, #contacto, .product-card");!i&&!s&&t>2?(e.classList.add("animate-on-scroll"),this.elementsToReveal.add(e)):(e.style.opacity="1",e.style.transform="translateY(0)",e.classList.add("visible"))}),console.log(`Marked ${this.elementsToReveal.size} elements for animation, ${e.length-this.elementsToReveal.size} immediately visible`)}initSafeScrollAnimations(){0!==this.elementsToReveal.size&&(window.IntersectionObserver?(this.visibilityObserver=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&this.elementsToReveal.has(e.target)&&(this.revealElement(e.target),this.elementsToReveal.delete(e.target),this.visibilityObserver.unobserve(e.target))})},{threshold:.1,rootMargin:"100px"}),this.elementsToReveal.forEach(e=>{this.visibilityObserver.observe(e)}),console.log(`👁️ Scroll animations enabled for ${this.elementsToReveal.size} elements`)):this.showAllElements())}revealElement(e){e.style.opacity="1",e.style.transform="translateY(0)",e.classList.add("visible")}showAllElements(){this.elementsToReveal.forEach(e=>this.revealElement(e)),this.elementsToReveal.clear()}initBasicInteractions(){this.initButtonFeedback(),this.initVideoHandling()}initButtonFeedback(){document.addEventListener("touchstart",e=>{const t=e.target.closest('button, .btn, [role="button"]');t&&!t.disabled&&(t.style.transform="scale(0.98)")},{passive:!0}),document.addEventListener("touchend",e=>{const t=e.target.closest('button, .btn, [role="button"]');t&&(t.style.transform="")},{passive:!0})}initVideoHandling(){getElements("video[autoplay]").forEach(e=>{e.muted=!0,e.playsInline=!0,e.setAttribute("aria-hidden","true"),e.play().catch(()=>{this.handleVideoFallback(e)})})}handleVideoFallback(e){e.style.display="none";const t=e.parentElement;if(t&&!t.querySelector(".video-fallback")){const e=document.createElement("div");e.className="video-fallback",e.style.cssText="\n                position: absolute;\n                inset: 0;\n                background: linear-gradient(135deg, #ad2118, #ea580c);\n                z-index: -1;\n            ",t.appendChild(e)}}handleVideos(){getElements("video").forEach(e=>{this.isLowEndDevice&&(e.pause(),this.handleVideoFallback(e))})}setupFallbacks(){this.fallbackTimeout=setTimeout(()=>{this.elementsToReveal.size>0&&(console.warn("⚠️ Animation fallback triggered - showing remaining elements"),this.showAllElements())},3e3),document.addEventListener("visibilitychange",()=>{!document.hidden&&this.elementsToReveal.size>0&&this.showAllElements()})}initEssentials(){this.updateCurrentYear(),this.initVisibilityOptimization()}updateCurrentYear(){const e=getElements("#current-year, .current-year"),t=(new Date).getFullYear();e.forEach(e=>e.textContent=t)}initVisibilityOptimization(){document.addEventListener("visibilitychange",()=>{const e=getElements("video");document.hidden?e.forEach(e=>{e.paused||(e.pause(),e.dataset.wasPaused="false")}):this.isLowEndDevice||e.forEach(e=>{"false"===e.dataset.wasPaused&&e.play().catch(()=>this.handleVideoFallback(e))})})}forceShowAll(){this.showAllElements(),this.ensureContentVisibility(),console.log("🔧 Force showed all content")}getMode(){return this.isLowEndDevice||this.reducedMotion?"accessible":"enhanced"}getStats(){return{isInitialized:this.isInitialized,mode:this.getMode(),pendingElements:this.elementsToReveal.size,isLowEndDevice:this.isLowEndDevice,reducedMotion:this.reducedMotion}}destroy(){this.visibilityObserver&&(this.visibilityObserver.disconnect(),this.visibilityObserver=null),this.fallbackTimeout&&(clearTimeout(this.fallbackTimeout),this.fallbackTimeout=null),this.elementsToReveal.clear(),this.isInitialized=!1,console.log("Animation manager destroyed")}}export const animationManager=new AnimationManager;