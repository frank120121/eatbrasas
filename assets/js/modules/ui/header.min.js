import{CONFIG}from"../config.js";import{getElement,getElements,toggleClasses,setAttributes,throttle,attachEventListeners}from"../utils.js";export class HeaderManager{constructor(e=null){this.showToast=e,this.header=null,this.lastScrollY=0,this.mobileMenu=null,this.mobileMenuToggles=[],this.isInitialized=!1,this.isMobileMenuOpen=!1,this.scrollHandler=null,this.resizeHandler=null,this.hideTimeout=null,this.autoHideDelay=2e3,this.isHeaderVisible=!0,this.scrollDirection=null,this.scrollThreshold=10,this.isScrolling=!1,this.scrollEndTimeout=null}init(){try{this.initElements(),this.initScrollEffects(),this.initMobileMenu(),this.initSmoothScrolling(),this.initResizeHandler(),this.isInitialized=!0,console.log("✅ Header functionality initialized")}catch(e){console.error("❌ Error initializing header:",e),this.showToast&&this.showToast("Error al inicializar el header","error")}}initElements(){if(this.header=getElement("header"),this.mobileMenu=getElement(".mobile-menu"),this.mobileMenuToggles=[...getElements(".mobile-menu-toggle")],!this.header)throw new Error("Header element not found");this.header.style.transition="transform 0.3s ease-in-out, opacity 0.3s ease-in-out",this.header.classList.add("sticky-header");window.scrollY<=50?(this.header.style.transform="translateY(-100%)",this.header.style.opacity="0",this.isHeaderVisible=!1,console.log("Header initialized - hidden (at top)")):(this.header.style.transform="translateY(0)",this.header.style.opacity="1",this.isHeaderVisible=!0,console.log("Header initialized - visible (scrolled)")),console.log(`Found header and ${this.mobileMenuToggles.length} mobile menu toggles`)}initScrollEffects(){this.header&&(this.lastScrollY=window.scrollY,this.scrollHandler=throttle(()=>{this.updateHeaderScrollState()},16),window.addEventListener("scroll",this.scrollHandler,{passive:!0}),this.updateHeaderScrollState())}updateHeaderScrollState(){if(!this.header)return;const e=window.scrollY,i=this.header.offsetHeight,t=e-this.lastScrollY;this.clearHideTimeout(),this.isScrolling=!0,this.scrollEndTimeout&&clearTimeout(this.scrollEndTimeout),this.scrollEndTimeout=setTimeout(()=>{this.isScrolling=!1,this.handleScrollEnd()},150),Math.abs(t)>this.scrollThreshold&&(this.scrollDirection=t>0?"down":"up"),e<=50?this.hideHeader():e<=1.5*i||"up"===this.scrollDirection?this.showHeader():"down"===this.scrollDirection&&e>2*i&&this.hideHeader(),this.lastScrollY=Math.max(0,e)}handleScrollEnd(){this.isHeaderVisible&&window.scrollY>1.5*this.header.offsetHeight&&!this.isMobileMenuOpen&&this.setHideTimeout()}showHeader(){this.header&&(this.isHeaderVisible||(this.isHeaderVisible=!0,this.header.style.transform="translateY(0)",this.header.style.opacity="1",console.log("Header shown")))}hideHeader(){this.header&&(this.isMobileMenuOpen||this.isHeaderVisible&&(this.isHeaderVisible=!1,this.header.style.transform="translateY(-100%)",this.header.style.opacity="0",console.log("Header hidden")))}setHideTimeout(){this.clearHideTimeout(),this.hideTimeout=setTimeout(()=>{window.scrollY>1.5*this.header?.offsetHeight&&!this.isScrolling&&!this.isMobileMenuOpen&&this.hideHeader()},this.autoHideDelay)}clearHideTimeout(){this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null)}initMobileMenu(){this.mobileMenu&&0!==this.mobileMenuToggles.length?(this.mobileMenuToggles.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),this.toggleMobileMenu()}),setAttributes(e,{"aria-expanded":"false","aria-controls":this.mobileMenu.id||"mobile-menu","aria-label":"Abrir menú de navegación"})}),this.initMobileMenuLinks(),this.initMobileMenuKeyboard(),this.initClickOutsideHandler(),console.log("✅ Mobile menu functionality initialized")):console.warn("Mobile menu elements not found - skipping mobile menu initialization")}initMobileMenuLinks(){if(!this.mobileMenu)return;const e=this.mobileMenu.querySelectorAll('a[href^="#"]');e.forEach(e=>{e.addEventListener("click",e=>{this.closeMobileMenu()})}),console.log(`Initialized ${e.length} mobile menu links`)}initMobileMenuKeyboard(){document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isMobileMenuOpen&&this.closeMobileMenu()}),this.mobileMenu&&this.mobileMenu.addEventListener("keydown",e=>{"Tab"===e.key&&this.isMobileMenuOpen&&this.handleTabNavigation(e)})}handleTabNavigation(e){const i=this.mobileMenu.querySelectorAll('a[href], button, [tabindex]:not([tabindex="-1"])'),t=i[0],s=i[i.length-1];e.shiftKey?document.activeElement===t&&(e.preventDefault(),s.focus()):document.activeElement===s&&(e.preventDefault(),t.focus())}initClickOutsideHandler(){document.addEventListener("click",e=>{this.isMobileMenuOpen&&this.mobileMenu&&!this.mobileMenu.contains(e.target)&&!this.mobileMenuToggles.some(i=>i.contains(e.target))&&this.closeMobileMenu()})}toggleMobileMenu(){this.isMobileMenuOpen?this.closeMobileMenu():this.openMobileMenu()}openMobileMenu(){if(!this.mobileMenu||this.isMobileMenuOpen)return;this.showHeader(),this.clearHideTimeout(),this.isMobileMenuOpen=!0,toggleClasses(this.mobileMenu,["show"],[]),document.body.style.overflow="hidden",this.mobileMenuToggles.forEach(e=>{setAttributes(e,{"aria-expanded":"true","aria-label":"Cerrar menú de navegación"})});const e=this.mobileMenu.querySelector("a, button");e&&setTimeout(()=>e.focus(),100),console.log("Mobile menu opened")}closeMobileMenu(){this.mobileMenu&&this.isMobileMenuOpen&&(this.isMobileMenuOpen=!1,toggleClasses(this.mobileMenu,[],["show"]),document.body.style.overflow="",this.mobileMenuToggles.forEach(e=>{setAttributes(e,{"aria-expanded":"false","aria-label":"Abrir menú de navegación"})}),this.mobileMenuToggles[0]&&this.mobileMenuToggles[0].focus(),window.scrollY>1.5*(this.header?.offsetHeight||0)&&this.setHideTimeout(),console.log("Mobile menu closed"))}initSmoothScrolling(){const e=attachEventListeners('a[href^="#"]',"click",e=>{this.handleSmoothScroll(e)});console.log(`✅ Initialized smooth scrolling for ${e} anchor links`)}handleSmoothScroll(e){e.preventDefault();const i=e.target.getAttribute("href"),t=getElement(i);t?this.smoothScrollToTarget(t):(console.warn("Scroll target not found:",i),this.showToast&&this.showToast("Sección no encontrada","warning",2e3))}smoothScrollToTarget(e,i=80){const t=e.getBoundingClientRect().top+window.pageYOffset-i;window.scrollTo({top:t,behavior:"smooth"});const s=e.id;s&&history.replaceState&&history.replaceState(null,null,`#${s}`)}initResizeHandler(){this.resizeHandler=throttle(()=>{this.handleResize()},250),window.addEventListener("resize",this.resizeHandler)}handleResize(){const e=window.innerWidth>=768;e&&this.isMobileMenuOpen&&this.closeMobileMenu(),e&&(document.body.style.overflow=""),console.log(`Window resized: ${window.innerWidth}px (${e?"desktop":"mobile"})`)}getHeaderState(){return{isVisible:this.isHeaderVisible,isMobileMenuOpen:this.isMobileMenuOpen,scrollPosition:window.scrollY,scrollDirection:this.scrollDirection,windowWidth:window.innerWidth,isInitialized:this.isInitialized,hasHideTimeout:!!this.hideTimeout,isScrolling:this.isScrolling}}scrollToSection(e,i=80){const t=getElement(`#${e}`);return!!t&&(this.smoothScrollToTarget(t,i),!0)}updateHeader(){this.updateHeaderScrollState()}onScroll(e){if("function"==typeof e){const i=throttle(e,16);return window.addEventListener("scroll",i,{passive:!0}),()=>window.removeEventListener("scroll",i)}}getMobileMenuState(){return{isOpen:this.isMobileMenuOpen,toggleCount:this.mobileMenuToggles.length,hasMenu:!!this.mobileMenu}}setAutoHideDelay(e){this.autoHideDelay=e}forceShowHeader(){this.clearHideTimeout(),this.showHeader()}forceHideHeader(){this.clearHideTimeout(),this.hideHeader()}getStats(){return{isVisible:this.isHeaderVisible,scrollY:window.scrollY,lastScrollY:this.lastScrollY,scrollDirection:this.scrollDirection,isScrolling:this.isScrolling,hasHideTimeout:!!this.hideTimeout,mobileMenuOpen:this.isMobileMenuOpen}}destroy(){this.clearHideTimeout(),this.scrollEndTimeout&&clearTimeout(this.scrollEndTimeout),this.scrollHandler&&window.removeEventListener("scroll",this.scrollHandler),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.closeMobileMenu(),document.body.style.overflow="",this.header=null,this.mobileMenu=null,this.mobileMenuToggles=[],this.isInitialized=!1,console.log("Header manager destroyed")}}export const headerManager=new HeaderManager;