import{getElements}from"../utils.js";export class ImageLoader{constructor(e=null){this.showToast=e,this.images=[],this.observer=null,this.isInitialized=!1,this.loadedCount=0,this.isLowEndDevice=!1,this.retryMap=new WeakMap,this.failsafeTimeout=null}async init(){this.performInit()}performInit(){try{if(this.detectDeviceCapabilities(),this.findAndPrepareImages(),0===this.images.length)return console.log("No images found to process"),void(this.isInitialized=!0);this.ensureImageVisibility(),this.initLoadingStrategy(),this.setupFailsafe(),this.isInitialized=!0,console.log(`‚úÖ Image loader initialized - ${this.images.length} images, ${this.getMode()} mode`)}catch(e){console.error("‚ùå Image loader error:",e),this.initFailsafe()}}detectDeviceCapabilities(){const e={lowMemory:navigator.deviceMemory&&navigator.deviceMemory<3,lowCPU:navigator.hardwareConcurrency&&navigator.hardwareConcurrency<4,slowConnection:navigator.connection&&("2g"===navigator.connection.effectiveType||"slow-2g"===navigator.connection.effectiveType||navigator.connection.downlink<1.5)};this.isLowEndDevice=Object.values(e).some(Boolean)}findAndPrepareImages(){this.images=[...getElements("img")],this.images.forEach((e,i)=>{e.style.opacity="1",e.style.visibility="visible",e.style.display="block",e.classList.remove("hidden","invisible"),e.dataset.src&&!e.src?(e.classList.add("lazy-loading"),e.loading="lazy"):e.src&&e.classList.add("loaded"),e.style.minHeight||e.naturalHeight||(e.style.minHeight="200px",e.style.backgroundColor="#f3f4f6")}),console.log(`Prepared ${this.images.length} images for loading`)}ensureImageVisibility(){this.images.forEach(e=>{const i=e.closest(".hidden.lg\\:flex"),s=e.closest(".lg\\:hidden"),t=window.innerWidth<1024;if(t&&i)return;if(!t&&s)return;if(null===e.offsetParent){const i=e.parentElement;if(i&&(t&&i.classList.contains("hidden")&&i.classList.contains("lg:flex")||!t&&i.classList.contains("lg:hidden")))return;return void(e.dataset.src&&!e.src&&(e.src=e.dataset.src))}e.style.visibility="visible",e.style.opacity="1",e.style.display="block",e.dataset.src&&!e.src&&(e.src=e.dataset.src);let a=e.parentElement,o=0;for(;a&&a!==document.body&&o<5;){const e=t&&a.classList.contains("hidden")&&a.classList.contains("lg:flex")||!t&&a.classList.contains("lg:hidden");if(!e&&null===a.offsetParent&&"none"===window.getComputedStyle(a).display)break;e||(a.style.visibility="visible",a.classList.remove("hidden","invisible")),a=a.parentElement,o++}})}initLoadingStrategy(){this.isLowEndDevice?this.initImmediateLoading():this.initIntelligentLoading()}initImmediateLoading(){this.images.forEach((e,i)=>{i<3?this.loadImage(e):setTimeout(()=>this.loadImage(e),100*i)}),console.log("‚ö° Immediate loading strategy active")}initIntelligentLoading(){this.loadCriticalImages(),window.IntersectionObserver?this.initLazyLoading():this.initImmediateLoading()}loadCriticalImages(){const e=this.images.slice(0,6);e.forEach(e=>this.loadImage(e)),console.log(`Loaded ${e.length} critical images immediately`)}initLazyLoading(){this.observer=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(this.loadImage(e.target),this.observer.unobserve(e.target))})},{rootMargin:"100px",threshold:.1}),this.images.slice(6).forEach(e=>{e.dataset.src&&!e.src&&this.observer.observe(e)}),console.log(`üëÅÔ∏è Lazy loading setup for ${this.images.length-6} images`)}loadImage(e){if(e.classList.contains("loaded")||e.classList.contains("loading"))return;e.classList.add("loading"),e.classList.remove("lazy-loading");const i=()=>{e.classList.remove("loading"),e.classList.add("loaded"),e.style.backgroundColor="",e.style.minHeight="",this.loadedCount++,t()},s=()=>{const i=this.retryMap.get(e)||0;i<1&&e.dataset.src?(this.retryMap.set(e,i+1),setTimeout(()=>{e.dataset.src&&(e.src=e.dataset.src)},1e3)):(e.classList.remove("loading"),e.classList.add("error"),this.setPlaceholder(e),t())},t=()=>{e.removeEventListener("load",i),e.removeEventListener("error",s)};e.addEventListener("load",i,{once:!0}),e.addEventListener("error",s,{once:!0}),e.dataset.src&&!e.src&&(e.src=e.dataset.src),e.complete&&e.naturalWidth>0&&i()}setPlaceholder(e){const i=e.getAttribute("width")||"300",s=e.getAttribute("height")||"200";e.src=`data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="${i}" height="${s}" viewBox="0 0 ${i} ${s}"%3E%3Crect width="100%" height="100%" fill="%23f3f4f6"/%3E%3Ctext x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23999" font-size="14"%3EImagen no disponible%3C/text%3E%3C/svg%3E`}setupFailsafe(){this.failsafeTimeout=setTimeout(()=>{this.images.forEach(e=>{e.classList.contains("loaded")||e.classList.contains("error")||(e.dataset.src&&!e.src&&(e.src=e.dataset.src),e.classList.add("loaded"))}),console.log("üîß Image loading failsafe triggered")},1e4)}initFailsafe(){console.warn("üö® Image loader failsafe mode"),this.images.forEach(e=>{e.style.opacity="1",e.style.visibility="visible",e.style.display="block",e.dataset.src&&!e.src&&(e.src=e.dataset.src),e.classList.add("loaded")})}forceLoadAll(){this.images.forEach(e=>{e.style.opacity="1",e.style.visibility="visible",e.style.display="block",e.dataset.src&&!e.src&&(e.src=e.dataset.src),e.classList.remove("loading","lazy-loading"),e.classList.add("loaded")}),console.log(`üöÄ Force loaded ${this.images.length} images`)}getMode(){return this.isLowEndDevice?"immediate":"intelligent"}getStats(){const e=this.images.filter(e=>!e.classList.contains("loaded")&&!e.classList.contains("error")).length,i=this.images.filter(e=>e.classList.contains("error")).length;return{total:this.images.length,loaded:this.loadedCount,errors:i,pending:e,mode:this.getMode()}}refresh(){this.observer&&this.observer.disconnect(),this.failsafeTimeout&&clearTimeout(this.failsafeTimeout),this.loadedCount=0,this.retryMap=new WeakMap,this.performInit()}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.failsafeTimeout&&(clearTimeout(this.failsafeTimeout),this.failsafeTimeout=null),this.images=[],this.retryMap=new WeakMap,this.isInitialized=!1,console.log("Image loader destroyed")}}export const imageLoader=new ImageLoader;