const SW_CONFIG={SW_URL:"/sw.js",UPDATE_CHECK_INTERVAL:3e5,DATA_LIMIT_MB:2,WARN_AT_PERCENTAGE:70,DEBUG:"localhost"===window.location.hostname};class ServiceWorkerManager{constructor(){this.registration=null,this.isOnline=navigator.onLine,this.dataUsage=0,this.updateCheckInterval=null,this.deferredPrompt=null,this.init()}async init(){if("serviceWorker"in navigator)try{await this.registerServiceWorker(),this.setupEventListeners(),this.startPeriodicTasks(),this.handleInstallPrompt(),console.log("✅ SW Manager initialized")}catch(e){console.error("❌ SW Manager initialization failed:",e)}else console.warn("Service Workers not supported")}async registerServiceWorker(){try{this.registration=await navigator.serviceWorker.register(SW_CONFIG.SW_URL,{scope:"/"}),console.log("✅ Service Worker registered"),this.registration.installing?this.trackInstalling(this.registration.installing):this.registration.waiting&&this.showUpdateNotification()}catch(e){throw console.error("❌ Service Worker registration failed:",e),e}}setupEventListeners(){navigator.serviceWorker.addEventListener("message",e=>{this.handleServiceWorkerMessage(e)}),window.addEventListener("online",()=>{console.log("📡 Back online"),this.isOnline=!0,this.showToast("🌐 Conexión restaurada","success")}),window.addEventListener("offline",()=>{console.log("📡 Gone offline"),this.isOnline=!1,this.showToast("📱 Modo offline activado","info")}),document.addEventListener("visibilitychange",()=>{document.hidden||this.checkForUpdates()}),navigator.connection&&navigator.connection.addEventListener("change",()=>{const{effectiveType:e,downlink:t}=navigator.connection;console.log(`📡 Connection: ${e}, ${t}Mbps`),("2g"===e||t<1)&&this.notifyServiceWorker("SLOW_CONNECTION",{effectiveType:e,downlink:t})})}handleServiceWorkerMessage(e){const{type:t,message:n}=e.data||{};switch(t){case"SW_READY":console.log("✅ Service Worker ready");break;case"UPDATE_AVAILABLE":this.showUpdateNotification();break;default:SW_CONFIG.DEBUG&&console.log("📨 SW Message:",t,n)}}async checkForUpdates(){if(this.registration)try{await this.registration.update(),this.registration.waiting&&this.showUpdateNotification()}catch(e){console.warn("❌ Update check failed:",e)}}showUpdateNotification(){this.showToast('\n            🔄 Nueva versión disponible con mejoras para México. \n            <button onclick="swManager.applyUpdate()" style="\n                background: #fff; \n                color: #ad2118; \n                border: none; \n                padding: 8px 12px; \n                border-radius: 5px; \n                margin-left: 10px; \n                cursor: pointer; \n                font-weight: bold;\n            ">Actualizar</button>\n        ',"info",1e4)}applyUpdate(){this.registration?.waiting?(this.registration.waiting.postMessage({type:"SKIP_WAITING"}),this.showToast("🔄 Aplicando actualización...","info")):console.warn("❌ No update waiting")}trackInstalling(e){e.addEventListener("statechange",()=>{"installed"===e.state&&(navigator.serviceWorker.controller?this.showUpdateNotification():(console.log("🎉 Service Worker installed"),this.showToast("✅ App lista para uso offline","success")))})}handleInstallPrompt(){window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.deferredPrompt=e,setTimeout(()=>{this.showInstallPrompt()},5e3)}),window.addEventListener("appinstalled",()=>{console.log("🎉 PWA installed"),this.showToast("🎉 App instalada correctamente","success"),this.deferredPrompt=null})}showInstallPrompt(){const e=localStorage.getItem("pwa-install-dismissed");if(e&&Date.now()<parseInt(e))return;const t=document.createElement("div");t.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            left: 20px;\n            background: #007bff;\n            color: white;\n            padding: 20px;\n            border-radius: 10px;\n            z-index: 10000;\n            font-family: inherit;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n            word-wrap: break-word;\n            max-width: 400px;\n            margin: 0 auto;\n        ";const n=document.createElement("div");n.style.cssText="display: flex; align-items: center; margin-bottom: 10px;";const o=document.createElement("span");o.textContent="🇲🇽",o.style.cssText="font-size: 20px; margin-right: 8px;";const i=document.createElement("strong");i.textContent="Instalar Brasas Smokehouse",n.appendChild(o),n.appendChild(i);const r=document.createElement("div");r.style.cssText="font-size: 14px; margin-bottom: 15px; line-height: 1.4;",r.innerHTML="✅ Funciona sin internet<br>✅ Ahorra datos móviles";const a=document.createElement("div"),s=document.createElement("button");s.textContent="📱 Instalar",s.style.cssText="\n            background: #fff; \n            color: #ad2118; \n            border: none; \n            padding: 10px 15px; \n            border-radius: 8px; \n            cursor: pointer; \n            font-weight: bold;\n            margin-right: 10px;\n        ",s.onclick=()=>{this.installPWA(),t.remove()};const d=document.createElement("button");d.textContent="Más tarde",d.style.cssText="\n            background: transparent; \n            color: #fff; \n            border: 1px solid rgba(255,255,255,0.5); \n            padding: 10px 15px; \n            border-radius: 8px; \n            cursor: pointer;\n        ",d.onclick=()=>{this.dismissInstall(),t.remove()};const l=document.createElement("button");l.textContent="×",l.style.cssText="\n            position: absolute;\n            top: 10px;\n            right: 10px;\n            background: none;\n            border: none;\n            color: white;\n            font-size: 20px;\n            cursor: pointer;\n            padding: 0;\n            width: 20px;\n            height: 20px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        ",l.onclick=()=>{t.remove()},a.appendChild(s),a.appendChild(d),t.appendChild(l),t.appendChild(n),t.appendChild(r),t.appendChild(a),document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.remove()},3e4)}async installPWA(){if(this.deferredPrompt)try{this.deferredPrompt.prompt();const{outcome:e}=await this.deferredPrompt.userChoice;console.log(`PWA install: ${e}`),this.deferredPrompt=null}catch(e){console.error("PWA installation failed:",e)}else console.log("No install prompt available")}dismissInstall(){localStorage.setItem("pwa-install-dismissed",Date.now()+6048e5),this.deferredPrompt=null}notifyServiceWorker(e,t={}){navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:e,data:{...t,market:"nogales-sonora",timestamp:(new Date).toISOString()}})}startPeriodicTasks(){this.updateCheckInterval=setInterval(()=>{!document.hidden&&this.isOnline&&this.checkForUpdates()},SW_CONFIG.UPDATE_CHECK_INTERVAL)}showToast(e,t="info",n=3e3){if("function"==typeof showToast)return showToast(e,t,n);const o=document.createElement("div");o.innerHTML=e,o.style.cssText=`\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            left: 20px;\n            background: ${"error"===t?"#dc3545":"success"===t?"#28a745":"warning"===t?"#ffc107":"#007bff"};\n            color: ${"warning"===t?"#212529":"white"};\n            padding: 15px;\n            border-radius: 10px;\n            z-index: 10000;\n            font-family: inherit;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n            word-wrap: break-word;\n            max-width: 400px;\n        `,document.body.appendChild(o);return o.querySelectorAll("button").forEach(e=>{e.addEventListener("click",()=>{o.parentNode&&o.remove()})}),setTimeout(()=>{o.parentNode&&o.remove()},n),o}getStatus(){return{supported:"serviceWorker"in navigator,registered:!!this.registration,active:!!this.registration?.active,isOnline:this.isOnline,dataUsage:this.dataUsage,hasDeferredPrompt:!!this.deferredPrompt}}destroy(){this.updateCheckInterval&&clearInterval(this.updateCheckInterval)}}let swManager;document.addEventListener("DOMContentLoaded",()=>{try{swManager=new ServiceWorkerManager,window.swManager=swManager,SW_CONFIG.DEBUG&&console.log("🔧 SW Manager available at window.swManager")}catch(e){console.error("❌ Failed to initialize SW Manager:",e)}}),window.addEventListener("beforeunload",()=>{swManager&&swManager.destroy()}),"undefined"!=typeof window&&(window.swManager=swManager);